<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<title>Lightbox</title>
<style type="text/css">
body {
  font-family: "Times New Roman";
}
td {
  font-variant-numeric: tabular-nums;
}
</style>
</head>
<body>
<div class="container">
<h1>Lightbox</h1>
<label for="file-input">Upload a CSV file containing wavelengths vs Spectral irradiance</label>
<input type="file" name="file" id="file-input"/>
<table class="table table-sm mt-4" id="spectrum-table">
</table>
</div>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script>

const fileInput = document.getElementById('file-input')
const spectrumTable = document.getElementById('spectrum-table')

const appendCells = (table, cellType, cells) => {
  const row = document.createElement("tr")
  const domCells = cells.map((cellText) =>  {
    const cell = document.createElement(cellType)
    const text = document.createTextNode(cellText)
    cell.appendChild(text)
    return cell
  })
  for (cell of domCells) {
    row.appendChild(cell)
  }
  table.appendChild(row)
  return domCells
}

const createSampleTableHeader = (table, sampleCount) => {
  const titles = ["Wavelength [nm]", "Spectral irradiance [W/(mÂ² nm)]"]
  const cells = appendCells(table, "th", titles)
  cells[1].setAttribute("colspan", sampleCount)
}

const createTableHeader = (table, sampleCount) => {
  const sampleTitles = new Array(sampleCount).fill("").map((_, index) => "S"+index)
  const titles = ["Condition", ...sampleTitles]
  console.log(titles)
  appendCells(table, "th", titles)
}

const asExponential = (number) => number.toExponential(2)
const asDecimal = (number) => number.toFixed(2)

const createTableRow = (table, wavelength, samples, formatter) => {
  const formattedSamples = samples.map(formatter)
  appendCells(table, "td", [wavelength, ...formattedSamples])
}

const handleFiles = async (event) => {
  const fileList = fileInput.files
  for (const file of fileList) {
    const fileContents = await file.text()
    const lines = fileContents.match(/[^\r\n]+/g)
    const fieldCount = lines[0].split(",").length
    mappedLines = lines.map((line) =>
      line.split(",").map(parseFloat)
    )

    const luminanceTotals = await calculateLuminance(mappedLines)
    createTableHeader(spectrumTable, fieldCount - 1)
    createTableRow(spectrumTable, "Illuminance [lux]", luminanceTotals, asDecimal)

    createSampleTableHeader(spectrumTable, fieldCount - 1)
    for (const line of mappedLines) {
      const [wavelength, ...samples] = line
      createTableRow(spectrumTable, wavelength, samples, asExponential)
    }
  }
}
fileInput.addEventListener("change", handleFiles, false);

const calculateLuminance = async (lines) => {
  const vl1924 = await getvl1924Data()

  const weightedSamples = lines.map((line) => {
    const [wavelength, ...samples] = line
    const weight = vl1924[wavelength]
    return samples.map((sample) =>
      sample * weight * 683
    )
  })

  return weightedSamples.reduce((acc, samples) => {
    return acc.map((luminance, index) =>
      luminance + samples[index]
    )},
    new Array(weightedSamples[0].length).fill(0)
  )
}

const loadJSON = (filename) => {
  return new Promise((resolve, reject) => {
    const request = new XMLHttpRequest()
    request.addEventListener("load", () => {
      resolve(JSON.parse(request.responseText))
    })
    request.open("GET", filename)
    request.send()
  })
}

const getvl1924Data = () => loadJSON("./vl1924.json")

</script>
</body>
</html>
